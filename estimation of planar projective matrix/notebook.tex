
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{HW4}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \section{CSE 252B: Computer Vision II, Winter 2018 -- Assignment
4}\label{cse-252b-computer-vision-ii-winter-2018-assignment-4}

\subsubsection{Instructor: Ben Ochoa}\label{instructor-ben-ochoa}

\subsubsection{Due: Wednesday, March 7, 2018, 11:59
PM}\label{due-wednesday-march-7-2018-1159-pm}

    \subsection{Instructions}\label{instructions}

\begin{itemize}
\tightlist
\item
  Review the academic integrity and collaboration policies on the course
  website.
\item
  This assignment must be completed individually.
\item
  This assignment contains both math and programming problems.
\item
  All solutions must be written in this notebook
\item
  Math problems must be done in Markdown/LATEX. Remember to show work
  and describe your solution.
\item
  Programming aspects of this assignment must be completed using Python
  in this notebook.
\item
  This notebook contains skeleton code, which should not be modified
  (This is important for standardization to facilate effeciant grading).
\item
  You may use python packages for basic linear algebra, but you may not
  use packages that directly solve the problem. Ask the instructor if in
  doubt.
\item
  You must submit this notebook exported as a pdf. You must also submit
  this notebook as an .ipynb file.
\item
  You must submit both files (.pdf and .ipynb) on Gradescope. You must
  mark each problem on Gradescope in the pdf.
\item
  It is highly recommended that you begin working on this assignment
  early.
\end{itemize}

    \subsection{Problem 1 (Programing): Feature Detection (20
points)}\label{problem-1-programing-feature-detection-20-points}

Download input data from the course website. The file
price\_center20.JPG contains image 1 and the file price\_center21.JPG
contains image 2.

For each input image, calculate an image where each pixel value is the
minor eigenvalue of the gradient matrix

\(N=\left[ \begin{array}{cc} \sum\limits_w I_x^2 & \sum\limits_w I_x I_y\\ \sum\limits_w I_x I_y & \sum\limits_w I_y^2 \end{array} \right]\)

where w is the window about the pixel, and \(I_x\) and \(I_y\) are the
gradient images in the x and y direction, respectively. Calculate the
gradient images using the fivepoint central difference operator. Set
resulting values that are below a specified threshold value to zero
(hint: calculating the mean instead of the sum in N allows for adjusting
the size of the window without changing the threshold value). Apply an
operation that suppresses (sets to 0) local (i.e., about a window)
nonmaximum pixel values in the minor eigenvalue image. Vary these
parameters such that around 600--650 features are detected in each
image. For resulting nonzero pixel values, determine the subpixel
feature coordinate using the Forstner corner point operator.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{from} \PY{n+nn}{PIL} \PY{k}{import} \PY{n}{Image}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{patches} \PY{k}{as} \PY{n+nn}{patches}
        \PY{k+kn}{from} \PY{n+nn}{scipy} \PY{k}{import} \PY{n}{signal}
        \PY{k+kn}{import} \PY{n+nn}{random}
        \PY{c+c1}{\PYZsh{} open the input images}
        \PY{n}{I1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{Image}\PY{o}{.}\PY{n}{open}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{price\PYZus{}center20.JPG}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{/}\PY{l+m+mf}{255.}
        \PY{n}{I2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{Image}\PY{o}{.}\PY{n}{open}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{price\PYZus{}center21.JPG}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{/}\PY{l+m+mf}{255.}
        
        \PY{c+c1}{\PYZsh{} Display the input images}
        \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{14}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
        
        \PY{k}{def} \PY{n+nf}{toHomo}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} converts points from inhomogeneous to homogeneous coordinates}
            \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{x}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{k}{def} \PY{n+nf}{fromHomo}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} converts points from homogeneous to inhomogeneous coordinates}
            \PY{k}{return} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{/}\PY{n}{x}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_3_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{k}{def} \PY{n+nf}{corner}\PY{p}{(}\PY{n}{I}\PY{p}{,} \PY{n}{w}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{w\PYZus{}nms}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} inputs: }
            \PY{c+c1}{\PYZsh{} I is the input image (may be mxn for BW or mxnx3 for RGB)}
            \PY{c+c1}{\PYZsh{} w is the size of the window used to compute the gradient matrix N}
            \PY{c+c1}{\PYZsh{} t is the minor eigenvalue threshold}
            \PY{c+c1}{\PYZsh{} w\PYZus{}nms is the size of the window used for nonmaximal supression}
            \PY{c+c1}{\PYZsh{} outputs:}
            \PY{c+c1}{\PYZsh{} J0 is the mxn image of minor eigenvalues of N before thresholding}
            \PY{c+c1}{\PYZsh{} J1 is the mxn image of minor eigenvalues of N after thresholding}
            \PY{c+c1}{\PYZsh{} J2 is the mxn image of minor eigenvalues of N after nonmaximal supression}
            \PY{c+c1}{\PYZsh{} pts0 is the 2xk list of coordinates of (pixel accurate) corners}
            \PY{c+c1}{\PYZsh{}     (ie. coordinates of nonzero values of J2)}
            \PY{c+c1}{\PYZsh{} pts1 is the 2xk list of coordinates of subpixel accurate corners}
            \PY{c+c1}{\PYZsh{}     found using the Forstner detector}
            
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}your code here\PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{m}\PY{p}{,} \PY{n}{n} \PY{o}{=} \PY{n}{I}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
            \PY{n}{J0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{J1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{J2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{}xgradient Ix matrix}
            \PY{c+c1}{\PYZsh{}ygradient Iy matrix}
            \PY{c+c1}{\PYZsh{}translation and summation to calculate the gradient matrices}
            \PY{n}{xgradient} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{xgradient}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{xgradient}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{xgradient}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{xgradient}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{xgradient}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{xgradient}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{8}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{xgradient}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{xgradient}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{ygradient} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{8}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{ygradient}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{I}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{}N1 average IxIx matrix}
            \PY{c+c1}{\PYZsh{}N2 average IxIy matrix}
            \PY{c+c1}{\PYZsh{}N3 average IyIy matrix}
            \PY{c+c1}{\PYZsh{}N01 IxIx matrix N02 IxIy N03 IyIy}
            \PY{n}{N1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{N2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{N3} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{N01} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{N02} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{N03} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{)}
            \PY{n}{xx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{yy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{xy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{xx} \PY{o}{=} \PY{n}{xgradient}\PY{o}{*}\PY{n}{xgradient}\PY{o}{/}\PY{n}{w}\PY{o}{/}\PY{n}{w}
            \PY{n}{yy} \PY{o}{=} \PY{n}{ygradient}\PY{o}{*}\PY{n}{ygradient}\PY{o}{/}\PY{n}{w}\PY{o}{/}\PY{n}{w}
            \PY{n}{xy} \PY{o}{=} \PY{n}{xgradient}\PY{o}{*}\PY{n}{ygradient}\PY{o}{/}\PY{n}{w}\PY{o}{/}\PY{n}{w}
            \PY{n}{convkernal}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{w}\PY{p}{,}\PY{n}{w}\PY{p}{)}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{:}
                \PY{n}{N01} \PY{o}{+}\PY{o}{=} \PY{n}{xx}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}
                \PY{n}{N02} \PY{o}{+}\PY{o}{=} \PY{n}{xy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}
                \PY{n}{N03} \PY{o}{+}\PY{o}{=} \PY{n}{yy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}
            \PY{n}{N1} \PY{o}{=} \PY{n}{signal}\PY{o}{.}\PY{n}{correlate2d}\PY{p}{(}\PY{n}{N01}\PY{p}{,} \PY{n}{convkernal}\PY{p}{,} \PY{n}{mode}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{boundary}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{symm}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{N2} \PY{o}{=} \PY{n}{signal}\PY{o}{.}\PY{n}{correlate2d}\PY{p}{(}\PY{n}{N02}\PY{p}{,} \PY{n}{convkernal}\PY{p}{,} \PY{n}{mode}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{boundary}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{symm}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{N3} \PY{o}{=} \PY{n}{signal}\PY{o}{.}\PY{n}{correlate2d}\PY{p}{(}\PY{n}{N03}\PY{p}{,} \PY{n}{convkernal}\PY{p}{,} \PY{n}{mode}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{boundary}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{symm}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{}calculate minor eigenvalues}
            \PY{c+c1}{\PYZsh{}same as the equation that use trace and determint}
            \PY{n}{J0}\PY{o}{=} \PY{p}{(}\PY{n}{N1} \PY{o}{+} \PY{n}{N3} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{N1} \PY{o}{+} \PY{n}{N3}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{l+m+mi}{4} \PY{o}{*} \PY{p}{(}\PY{n}{N1} \PY{o}{*} \PY{n}{N3} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{N2}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{/} \PY{l+m+mi}{2}
            \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{m}\PY{p}{)}\PY{p}{:}
                \PY{k}{for} \PY{n}{y} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{:}
                    \PY{n}{J1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{o}{=} \PY{n}{J0}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{k}{if} \PY{n}{J0}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{o}{\PYZgt{}} \PY{n}{t} \PY{k}{else} \PY{l+m+mi}{0}
            \PY{n}{lenw} \PY{o}{=} \PY{p}{(}\PY{n}{w\PYZus{}nms} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{p}{)} \PY{o}{/}\PY{o}{/} \PY{l+m+mi}{2}
            \PY{n}{flag} \PY{o}{=} \PY{k+kc}{False}
            \PY{c+c1}{\PYZsh{}nonmaximum suppression}
            \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{m}\PY{p}{)}\PY{p}{:}
                \PY{k}{for} \PY{n}{y} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{:}
                    \PY{n}{cmax} \PY{o}{=} \PY{n}{J1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}
                    \PY{k}{for} \PY{n}{x1} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{x} \PY{o}{\PYZhy{}} \PY{n}{lenw}\PY{p}{,} \PY{n}{x} \PY{o}{+} \PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                        \PY{k}{for} \PY{n}{y1} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{y} \PY{o}{\PYZhy{}} \PY{n}{lenw}\PY{p}{,} \PY{n}{y} \PY{o}{+} \PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                            \PY{k}{if} \PY{n}{x1} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{x1} \PY{o}{\PYZlt{}} \PY{n}{m} \PY{o+ow}{and} \PY{n}{y1} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{y1} \PY{o}{\PYZlt{}} \PY{n}{n}\PY{p}{:}
                                \PY{n}{cmax} \PY{o}{=} \PY{n+nb}{max}\PY{p}{(}\PY{n}{cmax}\PY{p}{,} \PY{n}{J1}\PY{p}{[}\PY{n}{x1}\PY{p}{]}\PY{p}{[}\PY{n}{y1}\PY{p}{]}\PY{p}{)}
                    \PY{n}{J2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{o}{=} \PY{n}{J1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{k}{if} \PY{n}{J1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{o}{==} \PY{n}{cmax} \PY{k}{else} \PY{l+m+mi}{0}
                    \PY{k}{if} \PY{o+ow}{not} \PY{n}{J2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                        \PY{k}{if} \PY{o+ow}{not} \PY{n}{flag}\PY{p}{:}
                            \PY{n}{pts0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{]}\PY{p}{)}
                            \PY{n}{flag} \PY{o}{=} \PY{k+kc}{True}
                        \PY{k}{else}\PY{p}{:}
                            \PY{n}{pts0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{pts0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)}
            \PY{n}{ptsize}\PY{o}{=}\PY{n}{pts0}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
            \PY{n}{pts1}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{pts0}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
            \PY{n}{lenw} \PY{o}{=} \PY{p}{(}\PY{n}{w} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{p}{)} \PY{o}{/}\PY{o}{/} \PY{l+m+mi}{2}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{ptsize}\PY{p}{)}\PY{p}{:}
                \PY{n}{x}\PY{o}{=}\PY{n}{pts0}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}
                \PY{n}{y}\PY{o}{=}\PY{n}{pts0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}
                \PY{n}{FCb1}\PY{o}{=}\PY{l+m+mi}{0}
                \PY{n}{FCb2}\PY{o}{=}\PY{l+m+mi}{0}
                \PY{k}{for} \PY{n}{x1} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{x} \PY{o}{\PYZhy{}} \PY{n}{lenw}\PY{p}{,} \PY{n}{x} \PY{o}{+} \PY{n}{lenw} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                    \PY{k}{for} \PY{n}{y1} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{y} \PY{o}{\PYZhy{}} \PY{n}{lenw}\PY{p}{,} \PY{n}{y} \PY{o}{+} \PY{n}{lenw} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                        \PY{k}{if} \PY{n}{x1} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{x1} \PY{o}{\PYZlt{}} \PY{n}{m} \PY{o+ow}{and} \PY{n}{y1} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{y1} \PY{o}{\PYZlt{}} \PY{n}{n}\PY{p}{:}
                            \PY{n}{FCb1}\PY{o}{+}\PY{o}{=}\PY{n}{x1}\PY{o}{*}\PY{n}{N01}\PY{p}{[}\PY{n}{x1}\PY{p}{]}\PY{p}{[}\PY{n}{y1}\PY{p}{]}\PY{o}{+}\PY{n}{y1}\PY{o}{*}\PY{n}{N02}\PY{p}{[}\PY{n}{x1}\PY{p}{]}\PY{p}{[}\PY{n}{y1}\PY{p}{]}
                            \PY{n}{FCb2}\PY{o}{+}\PY{o}{=}\PY{n}{x1}\PY{o}{*}\PY{n}{N02}\PY{p}{[}\PY{n}{x1}\PY{p}{]}\PY{p}{[}\PY{n}{y1}\PY{p}{]}\PY{o}{+}\PY{n}{y1}\PY{o}{*}\PY{n}{N03}\PY{p}{[}\PY{n}{x1}\PY{p}{]}\PY{p}{[}\PY{n}{y1}\PY{p}{]}
                \PY{n}{det}\PY{o}{=}\PY{n}{N1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{N3}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{N2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{N2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}
                \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n+nb}{int}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{det}\PY{o}{*}\PY{p}{(}\PY{n}{N3}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{FCb1}\PY{o}{\PYZhy{}}\PY{n}{N2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{FCb2}\PY{p}{)}\PY{p}{)}
                \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n+nb}{int}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{det}\PY{o}{*}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{N2}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{FCb1}\PY{o}{+}\PY{n}{N1}\PY{p}{[}\PY{n}{x}\PY{p}{]}\PY{p}{[}\PY{n}{y}\PY{p}{]}\PY{o}{*}\PY{n}{FCb2}\PY{p}{)}\PY{p}{)}
            \PY{n}{pts0}\PY{o}{=}\PY{n}{pts0}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n+nb}{int}\PY{p}{)}
            \PY{n}{pts1}\PY{o}{=}\PY{n}{pts1}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n+nb}{int}\PY{p}{)}
            \PY{c+c1}{\PYZsh{}drop the pts near the boundary}
            \PY{n}{ilist}\PY{o}{=}\PY{p}{[}\PY{n}{i} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{k}{if} \PY{n}{m}\PY{o}{\PYZhy{}}\PY{n}{lenw} \PY{o}{\PYZgt{}} \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{\PYZgt{}}\PY{o}{=}\PY{n}{lenw} \PY{o+ow}{and} \PY{n}{n}\PY{o}{\PYZhy{}}\PY{n}{lenw} \PY{o}{\PYZgt{}} \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{\PYZgt{}}\PY{o}{=}\PY{n}{lenw}\PY{p}{]}
            \PY{n}{pts1}\PY{o}{=}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{ilist}\PY{p}{]}
            \PY{n}{pts0}\PY{o}{=}\PY{n}{pts0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{ilist}\PY{p}{]}
            \PY{k}{return} \PY{n}{J0}\PY{p}{,} \PY{n}{J1}\PY{p}{,} \PY{n}{J2}\PY{p}{,} \PY{n}{pts0}\PY{p}{,} \PY{n}{pts1}
        
        
        \PY{c+c1}{\PYZsh{} parameters to tune}
        \PY{n}{w}\PY{o}{=}\PY{l+m+mi}{13}
        \PY{n}{t}\PY{o}{=}\PY{o}{.}\PY{l+m+mi}{1}
        \PY{n}{w\PYZus{}nms}\PY{o}{=}\PY{l+m+mi}{7}
        
        \PY{c+c1}{\PYZsh{} extract corners}
        \PY{n}{J1\PYZus{}0}\PY{p}{,} \PY{n}{J1\PYZus{}1}\PY{p}{,} \PY{n}{J1\PYZus{}2}\PY{p}{,} \PY{n}{pts1\PYZus{}0}\PY{p}{,} \PY{n}{pts1\PYZus{}1} \PY{o}{=} \PY{n}{corner}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{w}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{w\PYZus{}nms}\PY{p}{)}
        \PY{n}{J2\PYZus{}0}\PY{p}{,} \PY{n}{J2\PYZus{}1}\PY{p}{,} \PY{n}{J2\PYZus{}2}\PY{p}{,} \PY{n}{pts2\PYZus{}0}\PY{p}{,} \PY{n}{pts2\PYZus{}1} \PY{o}{=} \PY{n}{corner}\PY{p}{(}\PY{n}{I2}\PY{p}{,} \PY{n}{w}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{w\PYZus{}nms}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Display results}
        \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{14}\PY{p}{,}\PY{l+m+mi}{24}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} show pre\PYZhy{}thresholded corner heat map}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J1\PYZus{}0}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J2\PYZus{}0}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} show thresholded corner heat map}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J1\PYZus{}1}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J2\PYZus{}1}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} show corner heat map after nonmaximal supression}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J1\PYZus{}2}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{J2\PYZus{}2}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} show corners on origional images}
        \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} draw rectangles of size w around corners}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1\PYZus{}0}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
            \PY{n}{x}\PY{p}{,}\PY{n}{y} \PY{o}{=} \PY{n}{pts1\PYZus{}0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}
            \PY{n}{ax}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x}\PY{o}{\PYZhy{}}\PY{n}{w}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y}\PY{o}{\PYZhy{}}\PY{n}{w}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{w}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pts1\PYZus{}0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{pts1\PYZus{}0}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} display pixel accurate corners}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} display subpixel corners}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{found }\PY{l+s+si}{\PYZpc{}d}\PY{l+s+s1}{ corners}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{pts1\PYZus{}0}.shape[1])
        \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts2\PYZus{}0}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
            \PY{n}{x}\PY{p}{,}\PY{n}{y} \PY{o}{=} \PY{n}{pts2\PYZus{}0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}
            \PY{n}{ax}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x}\PY{o}{\PYZhy{}}\PY{n}{w}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y}\PY{o}{\PYZhy{}}\PY{n}{w}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{w}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pts2\PYZus{}0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{pts2\PYZus{}0}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{found }\PY{l+s+si}{\PYZpc{}d}\PY{l+s+s1}{ corners}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{pts2\PYZus{}0}.shape[1])
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ipykernel\_launcher.py:63: RuntimeWarning: invalid value encountered in sqrt

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_4_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsection{Problem 2 (Programing): Feature Matching (15
points)}\label{problem-2-programing-feature-matching-15-points}

Determine the set of one-to-one putative feature correspondences by
performing a brute-force search for the greatest correlation coefficient
value (in the range {[}-1, 1{]}) between the detected features in image
1 and the detected features in image 2. Only allow matches that are
above a specified correlation coefficient threshold value (note that
calculating the correlation coefficient allows for adjusting the size of
the matching window without changing the threshold value). Further, only
allow matches that are above a specified distance ratio threshold value,
where distance is measured to the next best match for a given feature.
Vary these parameters such that around 200 putative feature
correspondences are established. Optional: constrain the search to
coordinates in image 2 that are within a proximity of the detected
feature coordinates in image 1.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{k}{def} \PY{n+nf}{match}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{I2}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{w}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{d}\PY{p}{,} \PY{n}{p}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} inputs:}
            \PY{c+c1}{\PYZsh{} I1, I2 are the input images}
            \PY{c+c1}{\PYZsh{} pts1, pts2 are the point to be matched}
            \PY{c+c1}{\PYZsh{} w is the size of the window to compute correlation coefficients}
            \PY{c+c1}{\PYZsh{} t is the correlation coefficient threshold}
            \PY{c+c1}{\PYZsh{} d distance ration threshold}
            \PY{c+c1}{\PYZsh{} p is the proximity threshold}
            \PY{c+c1}{\PYZsh{} outputs:}
            \PY{c+c1}{\PYZsh{} inds is a 2xk matrix of matches where inds[0,i] indexs a point pts1 }
            \PY{c+c1}{\PYZsh{}     and inds[1,i] indexs a point in pts2, where k is the number of matches}
            \PY{c+c1}{\PYZsh{} scores is a vector of length k that contains the correlation}
            \PY{c+c1}{\PYZsh{}     coefficients of the matches}
            
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}your code here\PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{mask}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
            \PY{n}{lenw}\PY{o}{=}\PY{p}{(}\PY{n}{w}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{l+m+mi}{2}
            
            \PY{c+c1}{\PYZsh{}calculate correlation coefficients}
            \PY{n}{corr0}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{corr}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                    \PY{c+c1}{\PYZsh{}calculate for 3 channels then take the minimum}
                    \PY{k}{for} \PY{n}{k} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{:}
                        \PY{n}{x1}\PY{o}{=}\PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}
                        \PY{n}{y1}\PY{o}{=}\PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{i}\PY{p}{]}
                        \PY{n}{window1}\PY{o}{=}\PY{n}{I1}\PY{p}{[}\PY{n}{x1}\PY{o}{\PYZhy{}}\PY{n}{lenw}\PY{p}{:}\PY{n}{x1}\PY{o}{+}\PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{y1}\PY{o}{\PYZhy{}}\PY{n}{lenw}\PY{p}{:}\PY{n}{y1}\PY{o}{+}\PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{k}\PY{p}{]}
                        \PY{n}{list1}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{n}{window1}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{w}\PY{o}{*}\PY{n}{w}\PY{p}{)}\PY{p}{)}
                        \PY{n}{x2}\PY{o}{=}\PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}
                        \PY{n}{y2}\PY{o}{=}\PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}
                        \PY{n}{window2}\PY{o}{=}\PY{n}{I2}\PY{p}{[}\PY{n}{x2}\PY{o}{\PYZhy{}}\PY{n}{lenw}\PY{p}{:}\PY{n}{x2}\PY{o}{+}\PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{y2}\PY{o}{\PYZhy{}}\PY{n}{lenw}\PY{p}{:}\PY{n}{y2}\PY{o}{+}\PY{n}{lenw}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{k}\PY{p}{]}
                        \PY{n}{list2}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{n}{window2}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{w}\PY{o}{*}\PY{n}{w}\PY{p}{)}\PY{p}{)}
                        \PY{c+c1}{\PYZsh{}avoid nan}
                        \PY{n}{corr0}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{[}\PY{n}{k}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{corrcoef}\PY{p}{(}\PY{n}{list1}\PY{p}{,}\PY{n}{list2}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{corrcoef}\PY{p}{(}\PY{n}{list1}\PY{p}{,}\PY{n}{list2}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZlt{}}\PY{l+m+mi}{1} \PY{k}{else} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
                    \PY{n}{corr}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{o}{=}\PY{n+nb}{min}\PY{p}{(}\PY{n}{corr0}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{corr0}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{corr0}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
                    
            \PY{c+c1}{\PYZsh{}select match}
            \PY{n}{flag}\PY{o}{=}\PY{k+kc}{False}
            \PY{n}{inds}\PY{p}{,}\PY{n}{scores}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}
            \PY{k}{while} \PY{k+kc}{True}\PY{p}{:}
                \PY{n}{curcorr}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{mask}\PY{p}{,}\PY{n}{corr}\PY{p}{)}
                \PY{n}{position}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{argmax}\PY{p}{(}\PY{n}{curcorr}\PY{p}{)}
                \PY{n}{m}\PY{p}{,} \PY{n}{n} \PY{o}{=} \PY{n+nb}{divmod}\PY{p}{(}\PY{n}{position}\PY{p}{,} \PY{n}{corr}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                \PY{c+c1}{\PYZsh{}if the current max coef is smaller than threshhold, break the loop}
                \PY{k}{if} \PY{n}{corr}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{o}{\PYZlt{}}\PY{n}{t}\PY{p}{:}
                    \PY{k}{break}   
                \PY{n}{cmax}\PY{o}{=}\PY{n}{corr}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{p}{[}\PY{n}{n}\PY{p}{]}
                \PY{n}{corr}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
                
                \PY{c+c1}{\PYZsh{}find next best}
                \PY{n}{nextbest}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{amax}\PY{p}{(}\PY{n}{corr}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{n}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{amax}\PY{p}{(}\PY{n}{corr}\PY{p}{[}\PY{n}{m}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                
                \PY{c+c1}{\PYZsh{}distance ratio and proximity restrains}
                \PY{k}{if} \PY{n}{cmax}\PY{o}{\PYZgt{}}\PY{n}{nextbest} \PY{o+ow}{and} \PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{cmax}\PY{p}{)}\PY{o}{\PYZlt{}}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{nextbest}\PY{p}{)}\PY{o}{*}\PY{n}{d} \PYZbs{}
                \PY{o+ow}{and} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{p}{)}\PY{o}{+}\PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{o}{\PYZlt{}}\PY{n}{p}\PY{p}{:}
                    \PY{k}{if} \PY{o+ow}{not} \PY{n}{flag}\PY{p}{:}
                        \PY{n}{inds} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{p}{]}\PY{p}{)}
                        \PY{n}{scores}\PY{o}{=}\PY{n}{cmax}
                        \PY{n}{flag} \PY{o}{=} \PY{k+kc}{True}
                    \PY{k}{else}\PY{p}{:}
                        \PY{n}{inds} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{inds}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{m}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{n}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                        \PY{n}{scores}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{scores}\PY{p}{,}\PY{n}{cmax}\PY{p}{)}\PY{p}{)}
                \PY{n}{mask}\PY{p}{[}\PY{n}{m}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{corr}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                \PY{n}{mask}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{n}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{corr}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
            \PY{k}{return} \PY{n}{inds}\PY{p}{,} \PY{n}{scores}
        
        \PY{c+c1}{\PYZsh{} parameters to tune}
        \PY{n}{w1} \PY{o}{=} \PY{l+m+mi}{13}
        \PY{n}{t1} \PY{o}{=} \PY{l+m+mf}{0.65}
        \PY{n}{d1} \PY{o}{=} \PY{l+m+mi}{5}
        \PY{n}{p1} \PY{o}{=} \PY{l+m+mi}{130}
        
        \PY{c+c1}{\PYZsh{} do the matching}
        \PY{n}{inds}\PY{p}{,} \PY{n}{scores} \PY{o}{=} \PY{n}{match}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{I2}\PY{p}{,} \PY{n}{pts1\PYZus{}1}\PY{p}{,} \PY{n}{pts2\PYZus{}1}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{t1}\PY{p}{,} \PY{n}{d1}\PY{p}{,} \PY{n}{p1}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} create new arrays of points which are corresponding}
        \PY{n}{pts1}\PY{o}{=}\PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{]}
        \PY{n}{pts2}\PY{o}{=}\PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{]}
        
        \PY{c+c1}{\PYZsh{} display the results}
        \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{14}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{ax2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{found }\PY{l+s+si}{\PYZpc{}d}\PY{l+s+s1}{ putative matches}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{inds}.shape[1])
        \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{inds}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
            \PY{n}{ii} \PY{o}{=} \PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{i}\PY{p}{]}
            \PY{n}{jj} \PY{o}{=} \PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{i}\PY{p}{]}
            \PY{n}{x1} \PY{o}{=} \PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{ii}\PY{p}{]}
            \PY{n}{x2} \PY{o}{=} \PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{jj}\PY{p}{]}
            \PY{n}{y1} \PY{o}{=} \PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{ii}\PY{p}{]}
            \PY{n}{y2} \PY{o}{=} \PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{jj}\PY{p}{]}
            \PY{n}{ax1}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{x1}\PY{p}{,} \PY{n}{x2}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{y1}\PY{p}{,} \PY{n}{y2}\PY{p}{]}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZhy{}r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{ax1}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x1}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y1}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w1}\PY{p}{,}\PY{n}{w1}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
            \PY{n}{ax2}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{x2}\PY{p}{,} \PY{n}{x1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{y2}\PY{p}{,} \PY{n}{y1}\PY{p}{]}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZhy{}r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{ax2}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x2}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y2}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w1}\PY{p}{,}\PY{n}{w1}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_6_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsection{Problem 3 (Programing): Outlier Rejection (15
points)}\label{problem-3-programing-outlier-rejection-15-points}

The resulting set of putative point correspondences should contain both
inlier and outlier correspondences (i.e., false matches). Determine the
set of inlier point correspondences using the M-estimator Sample
Consensus (MSAC) algorithm, where the maximum number of attempts to find
a consensus set is determined adaptively. For each trial, you must use
the 4-point algorithm (as described in lecture) to estimate the planar
projective transformation from the 2D points in image 1 to the 2D points
in image 2. Calculate the (squared) Sampson error as a first order
approximation to the geometric error.

hint: this problem has codimension 2

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{k}{def} \PY{n+nf}{normalize2d}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{:}
             \PY{n}{x0mean}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
             \PY{n}{x1mean}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
             \PY{n}{x0var}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{var}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
             \PY{n}{x1var}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{var}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
             \PY{n}{sigma}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{x0var}\PY{o}{+}\PY{n}{x1var}\PY{p}{)}
             \PY{n}{s2d}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{/}\PY{p}{(}\PY{n}{sigma}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
             \PY{n}{H2d}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{s2d}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{s2d}\PY{o}{*}\PY{n}{x0mean}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{s2d}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{s2d}\PY{o}{*}\PY{n}{x1mean}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
             \PY{n}{x\PYZus{}nl}\PY{o}{=}\PY{n}{H2d}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{)}
             \PY{k}{return} \PY{n}{x\PYZus{}nl}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,}\PY{n}{H2d}
         
         \PY{k}{def} \PY{n+nf}{fourpointH}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{:}
             \PY{n}{e1}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
             \PY{n}{e2}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
             \PY{n}{e3}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
             \PY{n}{e4}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
             \PY{n}{lam}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}
             \PY{n}{H}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{lam}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{lam}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,}\PY{n}{lam}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{k}{return} \PY{n}{H}
         
         \PY{k}{def} \PY{n+nf}{matrixA}\PY{p}{(}\PY{n}{x1}\PY{p}{,}\PY{n}{x2}\PY{p}{)}\PY{p}{:}
             \PY{n}{x1}\PY{o}{=}\PY{n}{toHomo}\PY{p}{(}\PY{n}{x1}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
             \PY{n}{A}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
             \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{:}\PY{l+m+mi}{6}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{x1}
             \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{o}{=}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{x1}
             \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{=}\PY{n}{x1}
             \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{x1}
             \PY{k}{return} \PY{n}{A}
         
         \PY{k}{def} \PY{n+nf}{matrixJ}\PY{p}{(}\PY{n}{H}\PY{p}{,}\PY{n}{x1}\PY{p}{,}\PY{n}{x2}\PY{p}{)}\PY{p}{:}
             \PY{n}{J}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{x2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{=}\PY{n}{x1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{x1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{H}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{n}{J}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{J}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{k}{return} \PY{n}{J}
         
         \PY{k}{def} \PY{n+nf}{MSAC}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{max\PYZus{}iters}\PY{p}{,} \PY{n}{p}\PY{p}{,}\PY{n}{alpha}\PY{p}{,}\PY{n}{sigma}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}your code here\PYZdq{}\PYZdq{}\PYZdq{}}
             
             \PY{n}{maxtrails}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{inf}
             \PY{n}{mincost}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{inf}
             \PY{n}{iters} \PY{o}{=} \PY{l+m+mi}{0} \PY{c+c1}{\PYZsh{} number of MSAC itterations executed}
             \PY{n}{threshhold}\PY{o}{=}\PY{l+m+mi}{20} \PY{c+c1}{\PYZsh{} lower bound for the size of acceptable consensus set}
             \PY{c+c1}{\PYZsh{}look at the chi square distribution table and find that F2\PYZca{}\PYZhy{}1(0.95)=5.99}
             \PY{n}{tolerance}\PY{o}{=}\PY{l+m+mf}{5.99}
            
             \PY{n}{num\PYZus{}inlier}\PY{o}{=}\PY{l+m+mi}{0}
             \PY{k}{while}\PY{p}{(}\PY{n}{iters}\PY{o}{\PYZlt{}}\PY{n}{maxtrails}\PY{p}{)}\PY{p}{:}
                 
                 \PY{n}{iters}\PY{o}{=}\PY{n}{iters}\PY{o}{+}\PY{l+m+mi}{1}
                 \PY{c+c1}{\PYZsh{}select a random sample}
                 \PY{n}{indices}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{random}\PY{o}{.}\PY{n}{sample}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{}calculate model }
                 \PY{n}{H1}\PY{o}{=}\PY{n}{fourpointH}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{indices}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{H2}\PY{o}{=}\PY{n}{fourpointH}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{indices}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{H}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{H2}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{H1}\PY{p}{)}
                 \PY{n}{h}\PY{o}{=}\PY{n}{H}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{}print(H.dot)}
                 
                 \PY{n}{error}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{n}{cost}\PY{o}{=}\PY{l+m+mi}{0}
             
                 \PY{c+c1}{\PYZsh{}calculate sampson error}
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{Ai}\PY{o}{=}\PY{n}{matrixA}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                     \PY{n}{epsilon}\PY{o}{=}\PY{n}{Ai}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{h}\PY{p}{)}
                     \PY{n}{J}\PY{o}{=}\PY{n}{matrixJ}\PY{p}{(}\PY{n}{H}\PY{p}{,}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                     \PY{n}{lam}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{J}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{J}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon}\PY{p}{)}
                     \PY{n}{delta\PYZus{}x}\PY{o}{=}\PY{n}{J}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{lam}\PY{p}{)}
                     \PY{n}{error}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n}{delta\PYZus{}x}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{delta\PYZus{}x}\PY{p}{)}
                     \PY{n}{cost}\PY{o}{+}\PY{o}{=}\PY{n}{error}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{k}{if}\PY{p}{(}\PY{n}{error}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{\PYZlt{}}\PY{o}{=}\PY{n}{tolerance}\PY{p}{)} \PY{k}{else} \PY{n}{tolerance}
                 
                 \PY{c+c1}{\PYZsh{}print(error)}
                 \PY{k}{if}\PY{p}{(}\PY{n}{cost}\PY{o}{\PYZlt{}}\PY{n}{mincost}\PY{p}{)}\PY{p}{:}
                     \PY{n}{minerror}\PY{o}{=}\PY{n}{error}
                     \PY{n}{mincost}\PY{o}{=}\PY{n}{cost}
                     \PY{n}{mincost\PYZus{}H}\PY{o}{=}\PY{n}{H}
                  
                 \PY{c+c1}{\PYZsh{}\PYZsh{}calculate set of inliers, update max\PYZus{}trails}
                 \PY{n}{indices\PYZus{}inlier}\PY{o}{=}\PY{p}{[}\PY{n}{i} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{k}{if} \PY{n}{minerror}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{\PYZlt{}}\PY{o}{=}\PY{n}{tolerance}\PY{p}{]}
                 \PY{n}{num\PYZus{}inlier}\PY{o}{=}\PY{n+nb}{len}\PY{p}{(}\PY{n}{indices\PYZus{}inlier}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}if(num\PYZus{}inlier\PYZlt{}=threshhold):}
                  \PY{c+c1}{\PYZsh{}   break}
                 \PY{c+c1}{\PYZsh{}print(num\PYZus{}inlier)}
                 \PY{n}{maxtrails}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{p}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{l+m+mf}{0.9}\PY{o}{\PYZhy{}}\PY{p}{(}\PY{p}{(}\PY{n}{num\PYZus{}inlier}\PY{p}{)}\PY{o}{/}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
         
             \PY{n}{H} \PY{o}{=} \PY{n}{mincost\PYZus{}H} \PY{c+c1}{\PYZsh{} estimated H matrix}
             
             \PY{n}{H}\PY{o}{=}\PY{n}{H}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{H}\PY{p}{)}
             \PY{n}{inliers} \PY{o}{=} \PY{n}{indices\PYZus{}inlier} \PY{c+c1}{\PYZsh{} indices of inliers (must be sorted)}
             
             \PY{k}{return} \PY{n}{H}\PY{p}{,} \PY{n}{inliers}\PY{p}{,} \PY{n}{mincost}\PY{p}{,} \PY{n}{iters}
         
         
         \PY{c+c1}{\PYZsh{} MSAC hyperparameters (add any additional hyperparameters necessary here. For example p)}
         \PY{c+c1}{\PYZsh{} You should pass these hyperparameters as additional paramters to MSAC(...)}
         
         \PY{n}{p}\PY{o}{=}\PY{l+m+mf}{0.99}
         \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.95}
         \PY{n}{sigma}\PY{o}{=}\PY{l+m+mi}{1}
         \PY{n}{max\PYZus{}iters}\PY{o}{=}\PY{l+m+mi}{1}
         
         \PY{n}{H\PYZus{}MSAC}\PY{p}{,} \PY{n}{inliers}\PY{p}{,} \PY{n}{cost\PYZus{}MSAC}\PY{p}{,} \PY{n}{iters\PYZus{}MSAC} \PY{o}{=} \PY{n}{MSAC}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{max\PYZus{}iters}\PY{p}{,}\PY{n}{p}\PY{p}{,}\PY{n}{alpha}\PY{p}{,}\PY{n}{sigma}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{inliers: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{inliers}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{inlier count: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{inliers}\PY{p}{)}\PY{p}{)}
         
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cost\PYZus{}MSAC=}\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{cost\PYZus{}MSAC})
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{||H\PYZus{}MSAC||=}\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{np}.sqrt(np.sum(H\PYZus{}MSAC**2)))
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{H\PYZus{}MSAC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{H\PYZus{}MSAC}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{H\PYZus{}MSAC}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} display the results}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{14}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         \PY{n}{ax2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{inds}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
             \PY{n}{ii} \PY{o}{=} \PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{inliers}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}
             \PY{n}{jj} \PY{o}{=} \PY{n}{inds}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{inliers}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}
             \PY{n}{x1} \PY{o}{=} \PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{ii}\PY{p}{]}
             \PY{n}{x2} \PY{o}{=} \PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{jj}\PY{p}{]}
             \PY{n}{y1} \PY{o}{=} \PY{n}{pts1\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{ii}\PY{p}{]}
             \PY{n}{y2} \PY{o}{=} \PY{n}{pts2\PYZus{}1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{jj}\PY{p}{]}
             \PY{n}{ax1}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{x1}\PY{p}{,} \PY{n}{x2}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{y1}\PY{p}{,} \PY{n}{y2}\PY{p}{]}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZhy{}r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{ax1}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x1}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y1}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w1}\PY{p}{,}\PY{n}{w1}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
             \PY{n}{ax2}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{x2}\PY{p}{,} \PY{n}{x1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{y2}\PY{p}{,} \PY{n}{y1}\PY{p}{]}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZhy{}r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{ax2}\PY{o}{.}\PY{n}{add\PYZus{}patch}\PY{p}{(}\PY{n}{patches}\PY{o}{.}\PY{n}{Rectangle}\PY{p}{(}\PY{p}{(}\PY{n}{x2}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{y2}\PY{o}{\PYZhy{}}\PY{n}{w1}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{w1}\PY{p}{,}\PY{n}{w1}\PY{p}{,} \PY{n}{fill}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
inliers:  [0, 2, 3, 5, 6, 10, 11, 12, 13, 14, 15, 16, 20, 21, 24, 27, 28, 29, 30, 31, 32, 34, 35, 39, 40, 41, 42, 43, 45, 46, 47, 48, 49, 52, 53, 54, 55, 56, 57, 59, 60, 61, 62, 63, 64, 65, 68, 69, 70, 72, 74, 75, 77, 78, 80, 81, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 103, 104, 105, 106, 108, 109, 111, 112, 113, 114, 115, 116, 117, 118, 119, 121, 122, 123, 124, 127, 128, 129, 130, 131, 132, 134, 135, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 150, 151, 152, 153, 155, 157, 158, 159, 160, 161, 163, 167, 168, 169, 171, 172, 173, 174, 176, 177, 178, 180, 181, 182, 183, 184, 185, 186, 188, 190, 191, 192, 193, 195, 196, 199, 200, 201]
inlier count:  151
cost\_MSAC=490.802891
||H\_MSAC||=1.000000
H\_MSAC
[[ 1.16153595e-02 -1.12215389e-04 -9.95329576e-01]
 [ 2.23583693e-04  1.12193510e-02 -9.45271737e-02]
 [ 1.07016581e-06 -2.23481887e-07  1.10812729e-02]]

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_8_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsection{Problem 4 (Programing): Linear Estimate (15
points)}\label{problem-4-programing-linear-estimate-15-points}

Estimate the planar projective transformation
\(\boldsymbol{H}_\text{DLT}\) from the resulting set of inlier
correspondences using the direct linear transformation (DLT) algorithm
(with data normalization). You must express
\(\boldsymbol{x}'_i = \boldsymbol{H} \boldsymbol{x}_i\) as
\([\boldsymbol{x}'_i]^\perp \boldsymbol{H} \boldsymbol{x}_i = \boldsymbol{0}\)
(not
\(\boldsymbol{x}'_i \times \boldsymbol{H} \boldsymbol{x}_i = \boldsymbol{0}\)),
where \([\boldsymbol{x}'_i]^\perp \boldsymbol{x}'_i = \boldsymbol{0}\),
when forming the solution. Include the numerical values of the resulting
\(\boldsymbol{H}_\text{DLT}\), scaled such that
\(||\boldsymbol{H}_\text{DLT}||_\text{Fro} = 1\)

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{c+c1}{\PYZsh{}sampson correction as initial guess}
         \PY{k}{def} \PY{n+nf}{sampsoncorrection}\PY{p}{(}\PY{n}{pts1}\PY{p}{,}\PY{n}{pts2}\PY{p}{,}\PY{n}{H}\PY{p}{)}\PY{p}{:}
             \PY{n}{h}\PY{o}{=}\PY{n}{H}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{delta\PYZus{}x1}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{Ai}\PY{o}{=}\PY{n}{matrixA}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                 \PY{n}{epsilon}\PY{o}{=}\PY{n}{Ai}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{h}\PY{p}{)}
                 \PY{n}{J}\PY{o}{=}\PY{n}{matrixJ}\PY{p}{(}\PY{n}{H}\PY{p}{,}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                 \PY{n}{lam}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{J}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{J}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon}\PY{p}{)}
                 \PY{n}{delta\PYZus{}x}\PY{o}{=}\PY{n}{J}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{lam}\PY{p}{)}
                 \PY{n}{delta\PYZus{}x1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{n}{delta\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{k}{return} \PY{n}{pts1}\PY{o}{+}\PY{n}{delta\PYZus{}x1}
         
         
         \PY{k}{def} \PY{n+nf}{DLT}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}your code here\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{pts1\PYZus{}nl}\PY{p}{,}\PY{n}{H2d1}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts1}\PY{p}{)}
             \PY{n}{pts2\PYZus{}nl}\PY{p}{,}\PY{n}{H2d2}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts2}\PY{p}{)}
             \PY{n}{pts1\PYZus{}nl}\PY{o}{=}\PY{n}{toHomo}\PY{p}{(}\PY{n}{pts1\PYZus{}nl}\PY{p}{)}
             \PY{n}{pts2\PYZus{}nl}\PY{o}{=}\PY{n}{toHomo}\PY{p}{(}\PY{n}{pts2\PYZus{}nl}\PY{p}{)}
             \PY{n}{v}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{n}{A}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{}calculate v vector}
                 \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{p}{(}\PY{n}{pts2\PYZus{}nl}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{+}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{pts2\PYZus{}nl}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pts2\PYZus{}nl}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PYZbs{}
                 \PY{p}{,}\PY{n}{pts2\PYZus{}nl}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{ravel}\PY{p}{(}\PY{p}{)} 
                 
                 \PY{c+c1}{\PYZsh{}calculate H\PYZus{}v matrix}
                 \PY{n}{H\PYZus{}v}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{*}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{T}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                 \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{i}\PY{p}{:}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{2}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{kron}\PY{p}{(}\PY{n}{H\PYZus{}v}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,}\PY{n}{pts1\PYZus{}nl}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{u}\PY{p}{,}\PY{n}{sigma}\PY{p}{,}\PY{n}{vv}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{A}\PY{p}{)}
             
             \PY{n}{index}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n}{sigma}\PY{o}{==}\PY{n}{np}\PY{o}{.}\PY{n}{min}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}
             \PY{n}{Hcol}\PY{o}{=}\PY{n}{vv}\PY{p}{[}\PY{n}{index}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{:}\PY{p}{]}
             \PY{n}{H}\PY{o}{=}\PY{n}{Hcol}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
                
             \PY{c+c1}{\PYZsh{}back to unnormalized frame}
             \PY{n}{H} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{H2d2}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{H}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{H2d1}\PY{p}{)}
             \PY{n}{H}\PY{o}{=}\PY{n}{H}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{H}\PY{p}{)}
             
             \PY{n}{ptssi}\PY{o}{=}\PY{n}{sampsoncorrection}\PY{p}{(}\PY{n}{pts1}\PY{p}{,}\PY{n}{pts2}\PY{p}{,}\PY{n}{H}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{ptssi}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
             \PY{c+c1}{\PYZsh{}normalize and propagate covariance}
             \PY{n}{pts1\PYZus{}nl}\PY{p}{,}\PY{n}{H2d1}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts1}\PY{p}{)}
             \PY{n}{pts2\PYZus{}nl}\PY{p}{,}\PY{n}{H2d2}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts2}\PY{p}{)}
             
             \PY{n}{s1}\PY{o}{=}\PY{n}{H2d1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{s2}\PY{o}{=}\PY{n}{H2d2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{n}{Sigmax1}\PY{o}{=}\PY{n}{s1}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{Sigmax2}\PY{o}{=}\PY{n}{s2}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{}calculate current cost}
             
             \PY{n}{x\PYZus{}proj1}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{p}{(}\PY{n}{ptssi}\PY{p}{)}\PY{p}{)}
             \PY{n}{x\PYZus{}proj2}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{H}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{n}{epsilon\PYZus{}1}\PY{o}{=}\PY{n}{pts1\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj1}
             \PY{n}{epsilon\PYZus{}2}\PY{o}{=}\PY{n}{pts2\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj2}
             \PY{n}{cost}\PY{o}{=}\PY{l+m+mi}{0}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{cost}\PY{o}{=}\PY{n}{cost}\PY{o}{+}\PY{n}{epsilon\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                 \PY{n}{cost}\PY{o}{=}\PY{n}{cost}\PY{o}{+}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
             \PY{k}{return} \PY{n}{H}\PY{p}{,}\PY{n}{cost}
             
         
         \PY{n}{H\PYZus{}DLT}\PY{p}{,} \PY{n}{cost\PYZus{}DLT} \PY{o}{=} \PY{n}{DLT}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{,} \PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cost\PYZus{}DLT=}\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{cost\PYZus{}DLT})
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{||H\PYZus{}DLT||=}\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{np}.sqrt(np.sum(H\PYZus{}DLT**2)))
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{H\PYZus{}DLT}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{H\PYZus{}DLT}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{H\PYZus{}DLT}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
(2, 151)
(2, 151)
cost\_DLT=50.407445
||H\_DLT||=1.000000
H\_DLT
[[ 1.09851058e-02 -1.67292267e-05 -9.84599281e-01]
 [ 3.23773338e-04  1.06915168e-02 -1.73851988e-01]
 [ 1.26205180e-06  1.03263564e-07  1.02301086e-02]]

    \end{Verbatim}

    \subsection{Problem 5 (Programing): Nonlinear Estimate (45
points)}\label{problem-5-programing-nonlinear-estimate-45-points}

Use \(\boldsymbol{H}_\text{DLT}\) and the Sampson corrected points (in
image 1) as an initial estimate to an iterative estimation method,
specifically the sparse Levenberg-Marquardt algorithm, to determine the
Maximum Likelihood estimate of the planar projective transformation that
minimizes the reprojection error. You must parameterize the planar
projective transformation matrix and the homogeneous 2D scene points
that are being adjusted using the parameterization of homogeneous
vectors (see section A6.9.2 (page 624) of the textbook, and the
corrections and errata). Show the numerical values for the final
estimate of the planar projective transformation matrix
\(\boldsymbol{H}_\text{LM}\), scaled such that
\(||\boldsymbol{H}_\text{LM}||_\text{Fro} = 1\).

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{k}{def} \PY{n+nf}{sinc}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{x}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
                 \PY{k}{return} \PY{l+m+mi}{1}
             \PY{k}{else}\PY{p}{:}
                 \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{o}{/}\PY{n}{x}
         \PY{k}{def} \PY{n+nf}{frompavec}\PY{p}{(}\PY{n}{v}\PY{p}{)}\PY{p}{:}
             \PY{n}{norm}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{T}\PY{p}{,}\PY{n}{v}\PY{p}{)}\PY{p}{)}
             \PY{n}{a}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{norm}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{b}\PY{o}{=}\PY{n}{sinc}\PY{p}{(}\PY{n}{norm}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{v}
             \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{(}\PY{n}{a}\PY{p}{,}\PY{n}{b}\PY{p}{)}\PY{p}{)}
         \PY{k}{def} \PY{n+nf}{topavec}\PY{p}{(}\PY{n}{P}\PY{p}{)}\PY{p}{:}
             \PY{n}{a}\PY{o}{=}\PY{n}{P}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{b}\PY{o}{=}\PY{n}{P}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}
             \PY{n}{v}\PY{o}{=}\PY{l+m+mi}{2}\PY{o}{/}\PY{n}{sinc}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{arccos}\PY{p}{(}\PY{n}{a}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{n}{b}
             \PY{n}{norm}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{T}\PY{p}{,}\PY{n}{v}\PY{p}{)}\PY{p}{)}
             \PY{k}{if} \PY{n}{norm}\PY{o}{\PYZgt{}}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{:}
                 \PY{n}{v}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{n}{norm}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{ceil}\PY{p}{(}\PY{p}{(}\PY{n}{norm}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{n}{v}
             \PY{k}{return} \PY{n}{v}
         
         \PY{c+c1}{\PYZsh{}calculate  deparameterized vector partial derivatives }
         \PY{k}{def} \PY{n+nf}{partialpv}\PY{p}{(}\PY{n}{v}\PY{p}{)}\PY{p}{:}
             \PY{n}{length}\PY{o}{=}\PY{n+nb}{len}\PY{p}{(}\PY{n}{v}\PY{p}{)}
             \PY{n}{P0}\PY{o}{=}\PY{n}{frompavec}\PY{p}{(}\PY{n}{v}\PY{p}{)}
             \PY{n}{norm}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{T}\PY{p}{,}\PY{n}{v}\PY{p}{)}\PY{p}{)}
             \PY{n}{a}\PY{o}{=}\PY{n}{P0}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{b}\PY{o}{=}\PY{n}{P0}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}
             
             \PY{k}{if} \PY{n}{norm}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
                 \PY{n}{partialav}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{length}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{n}{partialbv}\PY{o}{=}\PY{l+m+mi}{1}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{n}{length}\PY{p}{,}\PY{n}{length}\PY{p}{)}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{partialav}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{b}\PY{o}{.}\PY{n}{T}
                 \PY{n}{partialbv}\PY{o}{=}\PY{n}{sinc}\PY{p}{(}\PY{n}{norm}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{n}{length}\PY{p}{,}\PY{n}{length}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}\PY{o}{/}\PY{l+m+mi}{4}\PY{o}{/}\PY{n}{norm}\PY{o}{*}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{norm}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{n}{norm}\PY{o}{*}\PY{l+m+mi}{2}\PYZbs{}
                 \PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{norm}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{n}{norm}\PY{o}{/}\PY{n}{norm}\PY{o}{*}\PY{l+m+mi}{4}\PY{p}{)}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{p}{,}\PY{n}{v}\PY{o}{.}\PY{n}{T}\PY{p}{)}
             \PY{n}{partialpv}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{(}\PY{n}{partialav}\PY{p}{,}\PY{n}{partialbv}\PY{p}{)}\PY{p}{)}
             \PY{k}{return} \PY{n}{partialpv}
         
         \PY{c+c1}{\PYZsh{} input vector of H h, 2D scene points}
         \PY{k}{def} \PY{n+nf}{calAi}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{h}\PY{p}{)}\PY{p}{:}
             \PY{n}{partialxh}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
             \PY{n}{XT}\PY{o}{=}\PY{n}{x}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
             \PY{n}{w}\PY{o}{=}\PY{n}{XT}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}
             \PY{n}{x\PYZus{}proj}\PY{o}{=}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{h}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{)}
             \PY{n}{Ai}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
             \PY{n}{Ai}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{=}\PY{n}{XT}
             \PY{n}{Ai}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{:}\PY{l+m+mi}{6}\PY{p}{]}\PY{o}{=}\PY{n}{XT}
             \PY{n}{Ai}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{XT}
             \PY{n}{Ai}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{XT}
             \PY{n}{partialxh}\PY{o}{=}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{w}\PY{o}{*}\PY{n}{Ai}
             \PY{k}{return} \PY{n}{partialxh}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{partialpv}\PY{p}{(}\PY{n}{topavec}\PY{p}{(}\PY{n}{h}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} input 2d homogeneous points xsi }
         \PY{k}{def} \PY{n+nf}{calBi}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{h}\PY{p}{)}\PY{p}{:}
             \PY{n}{partialxxsi}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
             \PY{n}{x\PYZus{}nl}\PY{o}{=}\PY{n}{x}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{x}\PY{p}{)}
             \PY{n}{h1}\PY{o}{=}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{h2}\PY{o}{=}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{:}\PY{l+m+mi}{6}\PY{p}{]}
             \PY{n}{h3}\PY{o}{=}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}
             \PY{n}{XT}\PY{o}{=}\PY{n}{x}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
             \PY{n}{w}\PY{o}{=}\PY{n}{XT}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}
             \PY{n}{x\PYZus{}proj}\PY{o}{=}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{h}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{)}
             \PY{c+c1}{\PYZsh{}print(x\PYZus{}proj)}
             \PY{n}{partialxxsi}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{h1}\PY{o}{.}\PY{n}{T}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{h3}\PY{o}{.}\PY{n}{T}
             \PY{n}{partialxxsi}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{h2}\PY{o}{.}\PY{n}{T}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{h3}\PY{o}{.}\PY{n}{T}
             \PY{n}{partialxxsi}\PY{o}{=}\PY{n}{partialxxsi}\PY{o}{/}\PY{n}{w}
             \PY{c+c1}{\PYZsh{}print(partialxxsi)}
             \PY{k}{return} \PY{n}{partialxxsi}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{partialpv}\PY{p}{(}\PY{n}{topavec}\PY{p}{(}\PY{n}{x\PYZus{}nl}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{c+c1}{\PYZsh{} feel free to modify the function signature as needed (pass parameterized H instead of homogeneous matrix, etc...)}
         \PY{k}{def} \PY{n+nf}{LMstep}\PY{p}{(}\PY{n}{H}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{ptssi}\PY{p}{,} \PY{n}{l}\PY{p}{,} \PY{n}{v}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}your code here\PYZdq{}\PYZdq{}\PYZdq{}}
             
             \PY{c+c1}{\PYZsh{}normalize and propagate covariance}
             \PY{n}{pts1\PYZus{}nl}\PY{p}{,}\PY{n}{H2d1}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts1}\PY{p}{)}
             \PY{n}{pts2\PYZus{}nl}\PY{p}{,}\PY{n}{H2d2}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{pts2}\PY{p}{)}
         
             \PY{n}{s1}\PY{o}{=}\PY{n}{H2d1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{s2}\PY{o}{=}\PY{n}{H2d2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{n}{Sigmax1}\PY{o}{=}\PY{n}{s1}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{Sigmax2}\PY{o}{=}\PY{n}{s2}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{}calculate current cost}
             \PY{n}{x\PYZus{}proj1}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{p}{(}\PY{n}{ptssi}\PY{p}{)}\PY{p}{)}
             \PY{n}{x\PYZus{}proj2}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{H}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{n}{epsilon\PYZus{}1}\PY{o}{=}\PY{n}{pts1\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj1}
             \PY{n}{epsilon\PYZus{}2}\PY{o}{=}\PY{n}{pts2\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj2}
             \PY{n}{cost}\PY{o}{=}\PY{l+m+mi}{0}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{cost}\PY{o}{=}\PY{n}{cost}\PY{o}{+}\PY{n}{epsilon\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                 \PY{n}{cost}\PY{o}{=}\PY{n}{cost}\PY{o}{+}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
             
             \PY{n}{U}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
             \PY{n}{V}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
             \PY{n}{W}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
             \PY{n}{epsilon\PYZus{}a}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
             \PY{n}{epsilon\PYZus{}b}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{Ai}\PY{o}{=}\PY{n}{calAi}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{H}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{n}{Bi1}\PY{o}{=}\PY{n}{calBi}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{n}{Bi2}\PY{o}{=}\PY{n}{calBi}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{H}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{U}\PY{o}{=}\PY{n}{U}\PY{o}{+}\PY{n}{Ai}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Ai}\PY{p}{)}
                 \PY{n}{V}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{Bi1}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Bi1}\PY{p}{)}\PY{o}{+}\PY{n}{Bi2}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Bi2}\PY{p}{)}
                 \PY{n}{W}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{n}{Ai}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Bi2}\PY{p}{)}
                 \PY{n}{epsilon\PYZus{}a}\PY{o}{=}\PY{n}{epsilon\PYZus{}a}\PY{o}{+}\PY{n}{Ai}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{epsilon\PYZus{}b}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n}{Bi1}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{o}{+}\PY{n}{Bi2}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)} 
             \PY{n}{flag}\PY{o}{=}\PY{k+kc}{True}
             \PY{k}{while} \PY{n}{flag}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{}print(l)}
                 \PY{n}{sumwvw}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
                 \PY{n}{sumwvb}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{sumwvw}\PY{o}{=}\PY{n}{sumwvw}\PY{o}{+}\PY{n}{W}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{V}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{l}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{p}{)}
                     \PY{n}{sumwvb}\PY{o}{=}\PY{n}{sumwvb}\PY{o}{+}\PY{n}{W}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{V}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{l}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}b}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{S}\PY{o}{=}\PY{n}{U}\PY{o}{+}\PY{n}{l}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{)}\PY{o}{+}\PY{n}{sumwvw}
                 \PY{n}{e}\PY{o}{=}\PY{n}{epsilon\PYZus{}a}\PY{o}{\PYZhy{}}\PY{n}{sumwvb}
                 \PY{n}{delta\PYZus{}a}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{S}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{e}\PY{p}{)}
                 \PY{n}{delta\PYZus{}b}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{delta\PYZus{}b}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{V}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{l}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}b}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{W}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{delta\PYZus{}a}\PY{p}{)}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} calculate candidate H matrix and scene points}
                 \PY{n}{hvec}\PY{o}{=}\PY{n}{topavec}\PY{p}{(}\PY{n}{H}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
                 \PY{n}{Hcandidate}\PY{o}{=}\PY{n}{frompavec}\PY{p}{(}\PY{n}{hvec}\PY{o}{+}\PY{n}{delta\PYZus{}a}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}
                 \PY{n}{ptscandidate}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                    
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{ptsvec}\PY{o}{=}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptssi}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                     \PY{n}{ptsvec}\PY{o}{=}\PY{n}{ptsvec}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{ptsvec}\PY{p}{)}
                     \PY{n}{ptscandidate}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{frompavec}\PY{p}{(}\PY{n}{topavec}\PY{p}{(}\PY{n}{ptsvec}\PY{p}{)}\PY{o}{+}\PY{n}{delta\PYZus{}b}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{:}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                
                 \PY{c+c1}{\PYZsh{} calculate projection}
                 \PY{n}{x\PYZus{}proj1}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{p}{(}\PY{n}{ptscandidate}\PY{p}{)}\PY{p}{)}
                 \PY{n}{x\PYZus{}proj2}\PY{p}{,}\PY{n}{\PYZus{}}\PY{o}{=}\PY{n}{normalize2d}\PY{p}{(}\PY{n}{fromHomo}\PY{p}{(}\PY{n}{H}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{toHomo}\PY{p}{(}\PY{n}{ptscandidate}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 \PY{n}{epsilon\PYZus{}11}\PY{o}{=}\PY{n}{pts1\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj1}
                 \PY{n}{epsilon\PYZus{}22}\PY{o}{=}\PY{n}{pts2\PYZus{}nl}\PY{o}{\PYZhy{}}\PY{n}{x\PYZus{}proj2}
                 \PY{n}{cost\PYZus{}1}\PY{o}{=}\PY{l+m+mi}{0}
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{cost\PYZus{}1}\PY{o}{=}\PY{n}{cost\PYZus{}1}\PY{o}{+}\PY{n}{epsilon\PYZus{}11}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax1}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}11}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
                     \PY{n}{cost\PYZus{}1}\PY{o}{=}\PY{n}{cost\PYZus{}1}\PY{o}{+}\PY{n}{epsilon\PYZus{}22}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{Sigmax2}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{epsilon\PYZus{}22}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
                 
                 \PY{k}{if} \PY{n}{cost\PYZus{}1}\PY{o}{\PYZlt{}}\PY{n}{cost}\PY{p}{:}
                     \PY{c+c1}{\PYZsh{}print(\PYZsq{}error = \PYZpc{}.20f\PYZsq{}\PYZpc{}(error\PYZus{}1))}
                     \PY{n}{flag}\PY{o}{=}\PY{k+kc}{False}
                     \PY{n}{l}\PY{o}{=}\PY{l+m+mf}{0.1}\PY{o}{*}\PY{n}{l}
                     \PY{n}{cost}\PY{o}{=}\PY{n}{cost\PYZus{}1}
                 \PY{k}{else}\PY{p}{:}
                     \PY{n}{l}\PY{o}{=}\PY{l+m+mi}{10}\PY{o}{*}\PY{n}{l}
             
             \PY{c+c1}{\PYZsh{}print(sampsoncorrection(pts1,pts2,Hcandidate)\PYZhy{}ptscandidate)}
             \PY{k}{return} \PY{n}{Hcandidate}\PY{p}{,} \PY{n}{cost}\PY{p}{,} \PY{n}{ptscandidate}\PY{p}{,} \PY{n}{l}
         
         \PY{c+c1}{\PYZsh{} LM hyperparameters}
         \PY{n}{l}\PY{o}{=}\PY{o}{.}\PY{l+m+mi}{001}
         \PY{n}{v}\PY{o}{=}\PY{l+m+mi}{10}
         \PY{n}{max\PYZus{}iters}\PY{o}{=}\PY{l+m+mi}{10}
         
         \PY{n}{H\PYZus{}LM} \PY{o}{=} \PY{n}{H\PYZus{}DLT}
         \PY{n}{prevcost}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{inf}
         \PY{c+c1}{\PYZsh{} sampson correction as initial guess}
         \PY{n}{ptssi}\PY{o}{=}\PY{n}{sampsoncorrection}\PY{p}{(}\PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{,}\PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{,}\PY{n}{H\PYZus{}DLT}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} LM optimization loop}
         \PY{n}{i}\PY{o}{=}\PY{l+m+mi}{0}
         \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{iter }\PY{l+s+si}{\PYZpc{}d}\PY{l+s+s1}{ cost }\PY{l+s+si}{\PYZpc{}.10f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{i}\PY{p}{,} \PY{n}{cost\PYZus{}DLT}\PY{p}{)}\PY{p}{)}
         \PY{k}{while} \PY{k+kc}{True}\PY{p}{:}
             \PY{n}{H\PYZus{}LM}\PY{p}{,} \PY{n}{cost\PYZus{}LM}\PY{p}{,} \PY{n}{ptssi}\PY{p}{,} \PY{n}{l} \PY{o}{=} \PY{n}{LMstep}\PY{p}{(}\PY{n}{H\PYZus{}LM}\PY{p}{,} \PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{,} \PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{inliers}\PY{p}{]}\PY{p}{,}\PY{n}{ptssi}\PY{p}{,} \PY{n}{l}\PY{p}{,} \PY{n}{v}\PY{p}{)}
             \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{iter }\PY{l+s+si}{\PYZpc{}d}\PY{l+s+s1}{ cost }\PY{l+s+si}{\PYZpc{}.10f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{p}{(}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{cost\PYZus{}LM}\PY{p}{)}\PY{p}{)}
             \PY{k}{if} \PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{cost\PYZus{}LM}\PY{o}{/}\PY{n}{prevcost}\PY{p}{)}\PY{o}{\PYZlt{}}\PY{l+m+mf}{1e\PYZhy{}5}\PY{p}{:}
                 \PY{k}{break}
             \PY{n}{prevcost}\PY{o}{=}\PY{n}{cost\PYZus{}LM}
             \PY{n}{i}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
         
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{||H\PYZus{}LM||=}\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{np}.sqrt(np.sum(H\PYZus{}LM**2)))
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{H\PYZus{}LM}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{H\PYZus{}LM}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{H\PYZus{}LM}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
iter 0 cost 50.4074449629
iter 1 cost 50.4074406475
iter 2 cost 50.4062323097
iter 3 cost 50.4050374343
iter 4 cost 50.4038558551
iter 5 cost 50.4026874085
iter 6 cost 50.4015319328
iter 7 cost 50.4003892687
iter 8 cost 50.3992592592
iter 9 cost 50.3981417490
iter 10 cost 50.3970365854
iter 11 cost 50.3959436174
iter 12 cost 50.3948626962
iter 13 cost 50.3937936750
iter 14 cost 50.3927364089
iter 15 cost 50.3916907549
iter 16 cost 50.3906565722
iter 17 cost 50.3896337215
iter 18 cost 50.3886220656
iter 19 cost 50.3876214690
iter 20 cost 50.3866317980
iter 21 cost 50.3856529208
iter 22 cost 50.3846847072
iter 23 cost 50.3837270287
iter 24 cost 50.3827797586
iter 25 cost 50.3818427717
iter 26 cost 50.3809159447
iter 27 cost 50.3799991557
iter 28 cost 50.3790922844
iter 29 cost 50.3781952121
iter 30 cost 50.3773078216
iter 31 cost 50.3764299974
iter 32 cost 50.3755616253
iter 33 cost 50.3747025927
iter 34 cost 50.3738527882
iter 35 cost 50.3730121022
iter 36 cost 50.3721804262
iter 37 cost 50.3713576533
iter 38 cost 50.3705436780
iter 39 cost 50.3697383958
iter 40 cost 50.3689417040
iter 41 cost 50.3681535008
iter 42 cost 50.3673765616
iter 43 cost 50.3665257410
iter 44 cost 50.3663374100
||H\_LM||=1.000000
H\_LM
[[ 1.09859436e-02 -1.73211746e-05 -9.84599270e-01]
 [ 3.23882285e-04  1.06917116e-02 -1.73851984e-01]
 [ 1.26362250e-06  1.02596698e-07  1.02301323e-02]]

    \end{Verbatim}


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
